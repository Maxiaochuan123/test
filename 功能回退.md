# 假如 新上了一个功能需要回退，本地 dev 分支，测试环境 test 分支

### 直接在本地操作（如果有权限，通常团队开发 通常 test/master 分支是受保护的，不能直接在本地操作，而且 reset 会丢失历史记录 不推荐）

#### 1. 先保存当前功能代码 (如果有保存的代码)
```bash
# 在功能分支上
git checkout dev
git stash save "暂存功能代码-待后续上线"

# 或者
git branch dev-bf # 创建备份分支
```

#### 2. test 测试环境分支 回退
```bash
# 切换到 test 分支
git checkout test
git reset --hard <上一个稳定版本的commit>  # 回退到合并前的状态
git push -f origin test  # 强制推送
```

#### 3. dev 开发环境分支 回退
```bash
# 切换回功能分支
git checkout dev
git reset --hard origin/test  # 重置到当前 test 的状态
git push -f origin dev
```

#### 4. 恢复功能代码 (如果有保存的代码)
```bash
# 切换回功能分支
git checkout dev
git stash apply stash@{0}  # 恢复暂存

# 或者恢复备份分支
git merge dev-bf
git push origin dev
```


### 如果本地没有权限，需要远程回退（GitLab 上的正确操作流程 Revert 模式更推荐，有完整的记录）

#### 1. 创建 Revert MR（Merge Request）
1. 在 GitLab 上找到之前合并到 test 的 MR
2. 点击 "Revert" 按钮
3. GitLab 会自动创建一个新的分支和 MR，用于回退之前的更改
4. 按正常流程审核和合并这个 Revert MR

#### 或者也可以在本地命令行完成回退分支的创建和回退，然后再到 GitLab 上创建 MR
```bash
# 1. 创建 Revert MR
git checkout -b revert-feature-xxx # 创建新分支来做 revert 操作
git revert -m 1 <M2的commit-hash> # 执行 revert 退回 M2 的合并 commit, 恢复到 M1 的版本
git push origin revert-feature-xxx # 推送到远程
```

#### 2. 更新本地功能分支
```bash
# 1. 更新本地 test 分支
git checkout test
git pull origin test  # 获取包含 revert 的更新

# 2. 重置功能分支
git checkout dev
git reset --hard origin/test
git push -f origin dev
```